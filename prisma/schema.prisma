// Prisma v6 Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============= USER ROLES =============
enum UserRole {
  USER
  GROUP_ADMIN
}

enum UserRoleStatus {
  ACTIVE
  SUSPENDED
  DISABLED
}

enum GroupMemberRole {
  ADMIN
  MEMBER
}

enum SystemAdminRole {
  SUPER_ADMIN
  SUPPORT
  ANALYST
}

enum TokenType {
  ACCESS
  REFRESH
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

// ============= CORE MODELS =============

model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  name         String
  avatarUrl    String?
  phone        String?

  // User Role System
  role       UserRole       @default(USER)
  roleStatus UserRoleStatus @default(ACTIVE)

  // System Admin Oversight
  roleStatusChangedAt DateTime?
  roleStatusChangedBy Int?
  roleStatusReason    String?

  settings Json? @default("{}")

  // Relationships
  groups        GroupMember[]  @relation("UserGroups")
  createdTasks  Task[]         @relation("TaskCreator")
  assignments   Assignment[]   @relation("UserAssignments")
  feedback      Feedback[]     @relation("UserFeedback")
  notifications Notification[] @relation("UserNotifications")
  
  // Authentication tokens (MOBILE APP USERS)
  refreshTokens RefreshToken[] @relation("UserRefreshTokens")

  // System Admin who changed status
  statusChangedByAdmin SystemAdmin? @relation("StatusChangedByAdmin", fields: [roleStatusChangedBy], references: [id])

  // Relationships to Admin
  adminModifications AdminAuditLog[] @relation("UserAdminAuditLogs")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@map("users")
}

model Group {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  inviteCode  String  @unique
  avatarUrl   String?
  settings    Json?   @default("{}")

  // Relationships
  members GroupMember[] @relation("GroupMembers")
  tasks   Task[]        @relation("GroupTasks")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("groups")
}

model GroupMember {
  id        Int             @id @default(autoincrement())
  userId    Int
  groupId   Int
  groupRole GroupMemberRole @default(MEMBER)

  // Relationships
  user  User  @relation("UserGroups", fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation("GroupMembers", fields: [groupId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([userId, groupId])
  @@map("group_members")
}

model Task {
  id          Int     @id @default(autoincrement())
  title       String
  description String?
  points      Int     @default(1)
  frequency   String  @default("ONCE")
  category    String?

  // Foreign keys
  groupId     Int
  createdById Int

  // Relationships
  group       Group        @relation("GroupTasks", fields: [groupId], references: [id], onDelete: Cascade)
  creator     User         @relation("TaskCreator", fields: [createdById], references: [id])
  assignments Assignment[] @relation("TaskAssignments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tasks")
}

model Assignment {
  id          Int       @id @default(autoincrement())
  taskId      Int
  userId      Int
  dueDate     DateTime
  completed   Boolean   @default(false)
  completedAt DateTime?
  verified    Boolean   @default(false)
  photoUrl    String?

  // Relationships
  task        Task         @relation("TaskAssignments", fields: [taskId], references: [id], onDelete: Cascade)
  user        User         @relation("UserAssignments", fields: [userId], references: [id])
  swapRequest SwapRequest? @relation("AssignmentSwapRequest")

  createdAt DateTime @default(now())

  @@index([dueDate])
  @@index([completed])
  @@index([userId, completed])
  @@map("assignments")
}

model SwapRequest {
  id           Int     @id @default(autoincrement())
  assignmentId Int     @unique
  reason       String?
  status       String  @default("PENDING")

  assignment Assignment @relation("AssignmentSwapRequest", fields: [assignmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("swap_requests")
}

model Notification {
  id      Int     @id @default(autoincrement())
  userId  Int
  type    String
  title   String
  message String
  read    Boolean @default(false)

  user User @relation("UserNotifications", fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@map("notifications")
}

model Feedback {
  id      Int    @id @default(autoincrement())
  userId  Int
  type    String
  message String
  status  String @default("OPEN")

  user User @relation("UserFeedback", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feedback")
}

// ============= SYSTEM ADMINS =============

model SystemAdmin {
  id           Int             @id @default(autoincrement())
  email        String          @unique
  passwordHash String
  name         String
  role         SystemAdminRole @default(SUPPORT)
  permissions  Json?           @default("[]")

  // Relationships
  modifiedUsers User[]          @relation("StatusChangedByAdmin")
  auditLogs     AdminAuditLog[] @relation("AdminAuditLogs")
  
  // Authentication tokens (WEB ADMIN USERS)
  refreshTokens AdminRefreshToken[] @relation("AdminRefreshTokens")

  // Status
  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_admins")
}

model AdminAuditLog {
  id           Int     @id @default(autoincrement())
  adminId      Int
  targetUserId Int?
  action       String
  details      Json?
  ipAddress    String?
  userAgent    String?

  // Relationships
  admin      SystemAdmin @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser User?       @relation("UserAdminAuditLogs", fields: [targetUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ============= AUTHENTICATION MODELS =============

// For MOBILE APP USERS
model RefreshToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  type      TokenType @default(REFRESH)
  expiresAt DateTime
  revoked   Boolean  @default(false)
  
  user      User     @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// For WEB ADMIN USERS (separate from mobile users)
model AdminRefreshToken {
  id        String      @id @default(uuid())
  adminId   Int
  token     String      @unique
  type      TokenType   @default(REFRESH)
  expiresAt DateTime
  revoked   Boolean     @default(false)
  
  admin     SystemAdmin @relation("AdminRefreshTokens", fields: [adminId], references: [id], onDelete: Cascade)
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  @@index([adminId])
  @@index([token])
  @@map("admin_refresh_tokens")
}