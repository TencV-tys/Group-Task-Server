// Prisma v6 Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============= USER ROLES =============
enum UserRole {
  USER
  GROUP_ADMIN
}

enum UserRoleStatus {
  ACTIVE
  SUSPENDED
  DISABLED
}

// SIMPLIFIED: Just ADMIN and MEMBER
enum GroupMemberRole {
  ADMIN    // Group Admin (creator)
  MEMBER   // Regular member
}

enum SystemAdminRole {
  SUPER_ADMIN
  SUPPORT
  ANALYST
}

enum TokenType {
  ACCESS
  REFRESH
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

// ============= CORE MODELS =============

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  fullName     String
  avatarUrl    String?
  gender       Gender?

  // User Role System
  role       UserRole       @default(USER)
  roleStatus UserRoleStatus @default(ACTIVE)

  // System Admin Oversight
  roleStatusChangedAt DateTime?
  roleStatusChangedBy String?
  roleStatusReason    String?

  settings Json? @default("{}")

  // Relationships
  groups            GroupMember[]      @relation("UserGroups")
  createdGroups     Group[]            @relation("GroupCreator")
  createdTasks      Task[]             @relation("TaskCreator")
  assignments       Assignment[]       @relation("UserAssignments")
  feedback          Feedback[]         @relation("UserFeedback")
  userNotifications UserNotification[]
  refreshTokens     RefreshToken[]     @relation("UserRefreshTokens")

  // System Admin who changed status
  statusChangedByAdmin SystemAdmin? @relation("StatusChangedByAdmin", fields: [roleStatusChangedBy], references: [id])

  // Relationships to Admin
  adminModifications AdminAuditLog[] @relation("UserAdminAuditLogs")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@map("users")
}

model Group {
  id          String  @id @default(uuid())
  name        String
  description String?
  inviteCode  String  @unique
  avatarUrl   String?
  settings    Json?   @default("{}")
  
  // NEW: Track who created the group
  createdById String

  // Relationships
  members GroupMember[] @relation("GroupMembers")
  tasks   Task[]        @relation("GroupTasks")
  creator User          @relation("GroupCreator", fields: [createdById], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("groups")
}

model GroupMember {
  id        String          @id @default(uuid())
  userId    String
  groupId   String
  groupRole GroupMemberRole @default(MEMBER)

  // Relationships
  user  User  @relation("UserGroups", fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation("GroupMembers", fields: [groupId], references: [id], onDelete: Cascade)

  joinedAt DateTime @default(now())

  @@unique([userId, groupId])
  @@map("group_members")
}

model Task {
  id          String  @id @default(uuid())
  title       String
  description String?
  points      Int     @default(1)
  frequency   String  @default("ONCE")
  category    String?

  // Foreign keys
  groupId     String
  createdById String

  // Relationships
  group       Group        @relation("GroupTasks", fields: [groupId], references: [id], onDelete: Cascade)
  creator     User         @relation("TaskCreator", fields: [createdById], references: [id])
  assignments Assignment[] @relation("TaskAssignments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tasks")
}

model Assignment {
  id          String    @id @default(uuid())
  taskId      String
  userId      String
  dueDate     DateTime
  completed   Boolean   @default(false)
  completedAt DateTime?
  verified    Boolean   @default(false)
  photoUrl    String?

  // Relationships
  task        Task         @relation("TaskAssignments", fields: [taskId], references: [id], onDelete: Cascade)
  user        User         @relation("UserAssignments", fields: [userId], references: [id])
  swapRequest SwapRequest? @relation("AssignmentSwapRequest")

  createdAt DateTime @default(now())

  @@index([dueDate])
  @@index([completed])
  @@index([userId, completed])
  @@map("assignments")
}

model SwapRequest {
  id           String  @id @default(uuid())
  assignmentId String  @unique
  reason       String?
  status       String  @default("PENDING")

  assignment Assignment @relation("AssignmentSwapRequest", fields: [assignmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("swap_requests")
}

model Feedback {
  id      String @id @default(uuid())
  userId  String
  type    String
  message String
  status  String @default("OPEN")

  user User @relation("UserFeedback", fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feedback")
}

// ============= NOTIFICATION MODELS =============

// For MOBILE APP USERS
model UserNotification {
  id      String  @id @default(uuid())
  userId  String
  type    String
  title   String
  message String
  data    Json?
  read    Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("user_notifications")
}

// For WEB ADMIN DASHBOARD
model AdminNotification {
  id       String      @id @default(uuid())
  adminId  String?
  type     String
  title    String
  message  String
  data     Json?
  read     Boolean     @default(false)
  priority String      @default("NORMAL")

  admin SystemAdmin? @relation(fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([read])
  @@index([priority])
  @@index([createdAt])
  @@map("admin_notifications")
}

// ============= SYSTEM ADMINS =============

model SystemAdmin {
  id           String          @id @default(uuid())
  email        String          @unique
  passwordHash String
  fullName     String
  role         SystemAdminRole @default(SUPPORT)
  permissions  Json?           @default("[]")

  // Relationships
  modifiedUsers      User[]              @relation("StatusChangedByAdmin")
  auditLogs          AdminAuditLog[]     @relation("AdminAuditLogs")
  adminNotifications AdminNotification[] // Admin notifications
  refreshTokens      AdminRefreshToken[] @relation("AdminRefreshTokens")

  // Status
  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_admins")
}

model AdminAuditLog {
  id           String  @id @default(uuid())
  adminId      String
  targetUserId String?
  action       String
  details      Json?
  ipAddress    String?
  userAgent    String?

  // Relationships
  admin      SystemAdmin @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser User?       @relation("UserAdminAuditLogs", fields: [targetUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([targetUserId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ============= AUTHENTICATION MODELS =============

// For MOBILE APP USERS
model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      TokenType @default(REFRESH)
  expiresAt DateTime
  revoked   Boolean   @default(false)

  user User @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// For WEB ADMIN USERS (separate from mobile users)
model AdminRefreshToken {
  id        String    @id @default(uuid())
  adminId   String
  token     String    @unique
  type      TokenType @default(REFRESH)
  expiresAt DateTime
  revoked   Boolean   @default(false)

  admin SystemAdmin @relation("AdminRefreshTokens", fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([adminId])
  @@index([token])
  @@map("admin_refresh_tokens")
}